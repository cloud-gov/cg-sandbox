---
jobs:
- name: notify-sandbox-users
  plan:
  - aggregate:
    - get: sandbox-config
    - get: notify-schedule
      trigger: true
  - task: notify
    file: sandbox-config/notify.yml
    params:
      API_ADDRESS: {{notify-api-url}}
      CLIENT_ID: {{notify-client-id}}
      CLIENT_SECRET: {{notify-client-secret}}
      ORG_NAME: {{notify-org-name}}
      SMTP_HOST: {{notify-smtp-host}}
      SMTP_USER: {{notify-smtp-user}}
      SMTP_PASS: {{notify-smtp-pass}}
      SMTP_PORT: {{notify-smtp-port}}
      MAIL_SENDER: {{notify-sender}}
  on_failure:
    put: slack
    params: &slack-params
      text: |
        :x: FAILED to notify sandbox users
        <$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME|View build details>
      channel: {{slack-channel}}
      username: {{slack-username}}
      icon_url: {{slack-icon-url}}
  on_success:
    put: slack
    params:
      <<: *slack-params
      text: |
        :white_check_mark: Successfully notified sandbox users
        <$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME|View build details>

- name: purge-sandboxes
  plan:
  - aggregate:
    - get: sandbox-config
    - get: purge-schedule
      trigger: true
  - task: purge
    file: sandbox-config/purge.yml
    params:
      API_ADDRESS: {{purge-api-url}}
      CLIENT_ID: {{purge-client-id}}
      CLIENT_SECRET: {{purge-client-secret}}
      ORG_NAME: {{purge-org-name}}
  on_failure:
    put: slack
    params:
      <<: *slack-params
      text: |
        :x: FAILED to purge sandbox org
        <$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME|View build details>
  on_success:
    put: slack
    params:
      <<: *slack-params
      text: |
        :white_check_mark: Successfully purged sandbox org
        <$ATC_EXTERNAL_URL/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME|View build details>

resources:
- name: sandbox-config
  type: git
  source:
    uri: {{sandbox-config-uri}}
    branch: {{sandbox-config-branch}}

- name: notify-schedule
  type: cron-resource
  source:
    expression: {{notify-schedule-expression}}
    location: {{notify-schedule-location}}

- name: purge-schedule
  type: cron-resource
  source:
    expression: {{purge-schedule-expression}}
    location: {{purge-schedule-location}}

- name: slack
  type: slack-notification
  source:
    url: {{slack-webhook-url}}

resource_types:
- name: cron-resource
  type: docker-image
  source:
    repository: cftoolsmiths/cron-test

- name: slack-notification
  type: docker-image
  source:
    repository: cfcommunity/slack-notification-resource
